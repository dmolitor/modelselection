<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="modelselection">
<title>Scaling with AWS • modelselection</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Scaling with AWS">
<meta property="og:description" content="modelselection">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">modelselection</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9003</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/scaling-with-aws.html">Scaling with AWS</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="scaling-with-aws_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Scaling with AWS</h1>
            
      
      
      <div class="d-none name"><code>scaling-with-aws.Rmd</code></div>
    </div>

    
    
<p>This vignette will walk through an example of scaling a <code>modelselection</code> analysis with AWS via the <a href="https://github.com/paws-r/paws" class="external-link">Paws SDK</a>. The following analysis depends on AWS credentials passed via environment variables. To see a detailed outline of the different ways to set AWS credentials, check out <a href="https://github.com/paws-r/paws/blob/main/docs/credentials.md" class="external-link">this how-to document</a>.</p>
<div class="section level2">
<h2 id="requisite-packages">Requisite Packages<a class="anchor" aria-label="anchor" href="#requisite-packages"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">e1071</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.dmolitor.com/modelselection/" class="external-link">modelselection</a></span><span class="op">)</span> <span class="co"># devtools::install_github("dmolitor/modelselection")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://parallelly.futureverse.org" class="external-link">parallelly</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paws-r/paws" class="external-link">paws</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsample.tidymodels.org" class="external-link">rsample</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/yardstick" class="external-link">yardstick</a></span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-and-model-prep">Data and Model Prep<a class="anchor" aria-label="anchor" href="#data-and-model-prep"></a>
</h2>
<div class="section level3">
<h3 id="data-prep">Data Prep<a class="anchor" aria-label="anchor" href="#data-prep"></a>
</h3>
<p>We’ll be training a classification model on the <code>iris</code> data-set to predict whether a flower’s species is virginica or not.</p>
<p>First, let’s generate a bunch of synthetic data observations by adding random noise to the original <code>iris</code> features and combining it into one big dataframe.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>
  what <span class="op">=</span> <span class="va">rbind</span>,
  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span>, <span class="va">iris</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span>
    Sepal.Length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/jitter.html" class="external-link">jitter</a></span><span class="op">(</span><span class="va">Sepal.Length</span>, <span class="fl">0.1</span><span class="op">)</span>,
    Sepal.Width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/jitter.html" class="external-link">jitter</a></span><span class="op">(</span><span class="va">Sepal.Width</span>, <span class="fl">0.1</span><span class="op">)</span>,
    Petal.Length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/jitter.html" class="external-link">jitter</a></span><span class="op">(</span><span class="va">Petal.Length</span>, <span class="fl">0.1</span><span class="op">)</span>,
    Petal.Width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/jitter.html" class="external-link">jitter</a></span><span class="op">(</span><span class="va">Petal.Width</span>, <span class="fl">0.1</span><span class="op">)</span>,
    Species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"virginica"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># Shuffle the data-set</span>
<span class="va">iris_new</span> <span class="op">&lt;-</span> <span class="va">iris_new</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">iris_new</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">iris_new</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span>

<span class="co"># Quick overview of the dataset</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">iris_new</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>
<span class="co">#   Sepal.Length    Sepal.Width     Petal.Length     Petal.Width     </span>
<span class="co">#  Min.   :4.298   Min.   :1.999   Min.   :0.9985   Min.   :0.09803  </span>
<span class="co">#  1st Qu.:5.101   1st Qu.:2.799   1st Qu.:1.5984   1st Qu.:0.30022  </span>
<span class="co">#  Median :5.799   Median :3.001   Median :4.3500   Median :1.30103  </span>
<span class="co">#  Mean   :5.843   Mean   :3.057   Mean   :3.7580   Mean   :1.19936  </span>
<span class="co">#  3rd Qu.:6.401   3rd Qu.:3.302   3rd Qu.:5.1004   3rd Qu.:1.80088  </span>
<span class="co">#  Max.   :7.902   Max.   :4.401   Max.   :6.9019   Max.   :2.50187</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="grid-search-specification">Grid Search Specification<a class="anchor" aria-label="anchor" href="#grid-search-specification"></a>
</h3>
<p>Now that we’ve got the data prepped, let’s specify our predictive modeling approach. For this analysis I’m going to train a Support Vector classifier using the <code>e1071</code> package, and I’m going to use Grid Search in combination with 5-fold Cross-Validation to find the optimal values for the <code>cost</code> and <code>kernel</code> hyper-parameters.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris_grid</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/GridSearchCV.html">GridSearchCV</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learner <span class="op">=</span> <span class="va">svm</span>,
  tune_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    cost <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">6</span><span class="op">)</span>,
    kernel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"polynomial"</span>, <span class="st">"radial"</span>, <span class="st">"sigmoid"</span><span class="op">)</span>
  <span class="op">)</span>,
  learner_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    scale <span class="op">=</span> <span class="cn">TRUE</span>,
    type <span class="op">=</span> <span class="st">"C-classification"</span>,
    probability <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>,
  splitter <span class="op">=</span> <span class="va">vfold_cv</span>,
  splitter_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,
  scorer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    accuracy <span class="op">=</span> <span class="va">accuracy_vec</span>,
    f_measure <span class="op">=</span> <span class="va">f_meas_vec</span>,
    auc <span class="op">=</span> <span class="va">roc_auc_vec</span>
  <span class="op">)</span>,
  prediction_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    accuracy <span class="op">=</span> <span class="cn">NULL</span>,
    f_measure <span class="op">=</span> <span class="cn">NULL</span>,
    auc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>probability <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>,
  convert_predictions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    accuracy <span class="op">=</span> <span class="cn">NULL</span>,
    f_measure <span class="op">=</span> <span class="cn">NULL</span>,
    auc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"probabilities"</span><span class="op">)</span><span class="op">[</span>, <span class="st">"FALSE"</span><span class="op">]</span>
  <span class="op">)</span>,
  optimize_score <span class="op">=</span> <span class="st">"max"</span>
<span class="op">)</span></code></pre></div>
<p>Now that we’ve specified our Grid Search schema let’s check out the hyper-parameter grid and see how many models we’re going to estimate.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"We will estimate"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">iris_grid</span><span class="op">$</span><span class="va">tune_params</span><span class="op">)</span>, <span class="st">"SVM models\n"</span><span class="op">)</span>
<span class="co"># We will estimate 18 SVM models</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="launch-aws-resources">Launch AWS Resources<a class="anchor" aria-label="anchor" href="#launch-aws-resources"></a>
</h2>
<p>To speed up the estimation of our models, let’s create a remote cluster of 6 worker nodes to estimate the models in parallel.</p>
<div class="section level3">
<h3 id="launch-ec2-instances">Launch EC2 Instances<a class="anchor" aria-label="anchor" href="#launch-ec2-instances"></a>
</h3>
<p>First, we will launch 6 instances using a custom AMI that contains R 4.1.3 and a bunch of essential R packages. While this AMI is not available as a community AMI there are definitely good AMIs out there that have a comprehensive set of R packages and corresponding tools installed. <strong>Note:</strong> which parameters you need to specify when launching EC2 instances may vary greatly depending on your account’s security configurations.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ec2_client</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/paws/man/ec2.html" class="external-link">ec2</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># Request Instances</span>
<span class="va">instance_req</span> <span class="op">&lt;-</span> <span class="va">ec2_client</span><span class="op">$</span><span class="fu">run_instances</span><span class="op">(</span>
  ImageId <span class="op">=</span> <span class="st">"ami-06dd49fc9e3a5acee"</span>,
  InstanceType <span class="op">=</span> <span class="st">"t2.large"</span>,
  KeyName <span class="op">=</span> <span class="va">key_name</span>,
  MaxCount <span class="op">=</span> <span class="fl">6</span>,
  MinCount <span class="op">=</span> <span class="fl">6</span>,
  InstanceInitiatedShutdownBehavior <span class="op">=</span> <span class="st">"terminate"</span>,
  SecurityGroupIds <span class="op">=</span> <span class="va">security_group</span>,
  <span class="co"># This names the instances</span>
  TagSpecifications <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
      ResourceType <span class="op">=</span> <span class="st">"instance"</span>,
      Tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
          Key <span class="op">=</span> <span class="st">"Name"</span>,
          Value <span class="op">=</span> <span class="st">"Worker Node"</span>
        <span class="op">)</span>
      <span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Now that we’ve launched the instances we need to wait until they all respond as <code>"running"</code> before we try to do anything (We also need to wait for ~ 1 minute for the instances to initialize or they’ll reject our SSH login attempts).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Chalk up a quick function to return instance IDs from our request</span>
<span class="va">instance_ids</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">response</span><span class="op">$</span><span class="va">Instances</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">i</span><span class="op">$</span><span class="va">InstanceId</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Wait for instances to all respond as 'running'</span>
<span class="kw">while</span><span class="op">(</span>
  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span>
      <span class="va">ec2_client</span><span class="op">$</span>
      <span class="fu">describe_instances</span><span class="op">(</span>InstanceIds <span class="op">=</span> <span class="fu">instance_ids</span><span class="op">(</span><span class="va">instance_req</span><span class="op">)</span><span class="op">)</span><span class="op">$</span>
      <span class="va">Reservations</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span>
      <span class="va">Instances</span>,
      <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">i</span><span class="op">$</span><span class="va">State</span><span class="op">$</span><span class="va">Name</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">==</span> <span class="st">"running"</span>
  <span class="op">)</span>
<span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Rough heuristic -- give additional 45 seconds for instances to initialize</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">45</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-cluster">Create Cluster<a class="anchor" aria-label="anchor" href="#create-cluster"></a>
</h3>
<p>Now, in order to set up our compute cluster we need to get the IP addresses from these instances.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get public IPs</span>
<span class="va">inst_public_ips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span>
  <span class="va">ec2_client</span><span class="op">$</span>
    <span class="fu">describe_instances</span><span class="op">(</span>InstanceIds <span class="op">=</span> <span class="fu">instance_ids</span><span class="op">(</span><span class="va">instance_req</span><span class="op">)</span><span class="op">)</span><span class="op">$</span>
    <span class="va">Reservations</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span>
    <span class="va">Instances</span>,
  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">i</span><span class="op">$</span><span class="va">PublicIpAddress</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Finally, we can create a compute cluster on these worker nodes via SSH.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://future.futureverse.org/reference/re-exports.html" class="external-link">makeClusterPSOCK</a></span><span class="op">(</span>
  worker <span class="op">=</span> <span class="va">inst_public_ips</span>,
  user <span class="op">=</span> <span class="st">"ubuntu"</span>,
  rshopts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"-o"</span>, <span class="st">"StrictHostKeyChecking=no"</span>,
              <span class="st">"-o"</span>, <span class="st">"IdentitiesOnly=yes"</span>,
              <span class="st">"-i"</span>, <span class="va">pem_fp</span><span class="op">)</span>, <span class="co"># Local filepath to private SSH key-pair</span>
  connectTimeout <span class="op">=</span> <span class="fl">25</span>,
  tries <span class="op">=</span> <span class="fl">3</span>
<span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="estimate-models">Estimate Models<a class="anchor" aria-label="anchor" href="#estimate-models"></a>
</h2>
<p>Now that we’ve created our compute cluster, we can use the <code>future</code> package to specify our parallelization plan. Since <code>modelselection</code> is built on top of the <code>future</code> framework, it will automatically parallelize the model estimation across our 6-worker cluster. The following parallelization <strong>topology</strong> basically is telling <code>future</code> to parallelize the grid-search models across the compute cluster, and to parallelize each model’s cross-validation across the cores of the instance it is being evaluated on.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://future.futureverse.org/reference/tweak.html" class="external-link">tweak</a></span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="va">cl</span><span class="op">)</span>,
    <span class="va">multisession</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Finally, let’s estimate our Grid Search models in parallel!</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris_grid_fitted</span> <span class="op">&lt;-</span> <span class="va">iris_grid</span><span class="op">$</span><span class="fu">fit</span><span class="op">(</span>
  formula <span class="op">=</span> <span class="va">Species</span> <span class="op">~</span> <span class="va">.</span>,
  data <span class="op">=</span> <span class="va">iris_new</span>,
  progress <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="best-modelparameters">Best Model/Parameters<a class="anchor" aria-label="anchor" href="#best-modelparameters"></a>
</h2>
<p>Let’s check out the info on our best model.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">best_idx</span> <span class="op">&lt;-</span> <span class="va">iris_grid_fitted</span><span class="op">$</span><span class="va">best_idx</span>
<span class="va">metrics</span> <span class="op">&lt;-</span> <span class="va">iris_grid_fitted</span><span class="op">$</span><span class="va">metrics</span>

<span class="co"># Print model metrics of best model</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span>
  <span class="st">" Accuracy:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">metrics</span><span class="op">$</span><span class="va">accuracy</span><span class="op">[[</span><span class="va">best_idx</span><span class="op">]</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>,
  <span class="st">"%\nF-Measure:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">metrics</span><span class="op">$</span><span class="va">f_measure</span><span class="op">[[</span><span class="va">best_idx</span><span class="op">]</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>,
  <span class="st">"%\n      AUC:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">metrics</span><span class="op">$</span><span class="va">auc</span><span class="op">[[</span><span class="va">best_idx</span><span class="op">]</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span>
<span class="op">)</span>
<span class="co">#  Accuracy: 98.47 %</span>
<span class="co"># F-Measure: 98.85 %</span>
<span class="co">#       AUC: 0.999</span>

<span class="va">params</span> <span class="op">&lt;-</span> <span class="va">iris_grid_fitted</span><span class="op">$</span><span class="va">best_params</span>

<span class="co"># Print the best hyper-parameters</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span>
  <span class="st">"  Optimal Cost:"</span>, <span class="va">params</span><span class="op">[[</span><span class="st">"cost"</span><span class="op">]</span><span class="op">]</span>,
  <span class="st">"\nOptimal Kernel:"</span>, <span class="va">params</span><span class="op">[[</span><span class="st">"kernel"</span><span class="op">]</span><span class="op">]</span>, <span class="st">"\n"</span>
<span class="op">)</span>
<span class="co">#   Optimal Cost: 6 </span>
<span class="co"># Optimal Kernel: polynomial</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="kill-aws-resources">Kill AWS Resources<a class="anchor" aria-label="anchor" href="#kill-aws-resources"></a>
</h2>
<p>Now that we’ve completed our mini-analysis let’s make sure to kill all our AWS resources. Since all we’ve done is launch EC2 instances, all this consists of is making sure that the instances are all shut down.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ec2_client</span><span class="op">$</span><span class="fu">stop_instances</span><span class="op">(</span>
  InstanceIds <span class="op">=</span> <span class="fu">instance_ids</span><span class="op">(</span><span class="va">instance_req</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Daniel Molitor.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
